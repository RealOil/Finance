# 입력 검증 및 에러 처리

## 현재 요구사항 문서의 관련 내용

### 기존 명시 사항

- 에러 메시지: 사용자 친화적 문구 사용 (3.2 사용성)
- API 호출 실패 시 graceful degradation (기본값 사용) (3.1 성능)
- 입력 필드에 도움말/예시 표시 (3.2 사용성)

---

## 추가 확인 필요 사항

### 1. 음수 입력 처리

**문제 상황**:

- 자산에 음수 입력
- 부채에 음수 입력 (부채는 보통 양수로 입력)
- 연봉/지출에 음수 입력

**제안**:

#### 옵션 A: 자동 보정 (추천)

- **자산**: 음수 입력 시 경고 메시지 + 자동으로 0으로 설정
  - 메시지: "자산은 0 이상이어야 합니다. 0으로 설정했습니다."
- **부채**: 음수 입력 시 양수로 변환 (사용자 확인)
  - 메시지: "부채는 양수로 입력해주세요. -XXX를 XXX로 변경했습니다."
- **연봉/지출**: 음수 입력 시 경고 + 0으로 설정
  - 메시지: "연봉/지출은 0 이상이어야 합니다."

#### 옵션 B: 엄격한 검증

- 음수 입력 시 즉시 에러 메시지 표시
- 입력 필드에 빨간 테두리 표시
- 계산 버튼 비활성화

**권장**: 옵션 A (자동 보정) - 사용자 경험 우선

---

### 2. 범위 검증

**문제 상황**:

- 나이: 0 이하 또는 비현실적으로 큰 값 (예: 200세)
- 연봉: 0 또는 비현실적으로 큰 값
- 은퇴 나이: 현재 나이보다 작거나 비현실적으로 큰 값

**제안**:

| 입력 항목      | 최소값        | 최대값               | 검증 규칙                 |
| -------------- | ------------- | -------------------- | ------------------------- |
| 현재 나이      | 0             | 150                  | 정수만 허용               |
| 기대 은퇴 나이 | 현재 나이 + 1 | 100                  | 현재 나이보다 커야 함     |
| 연봉           | 0             | 1,000,000,000 (10억) | 단위: 만원 기준           |
| 월 지출        | 0             | 연봉의 200%          | 경고만 표시 (과소비 경고) |
| 자산           | 0             | 제한 없음            | 음수만 방지               |
| 부채           | 0             | 제한 없음            | 음수만 방지               |

**구현 방법**:

```python
# 예시 검증 로직
if current_age < 0 or current_age > 150:
    st.error("나이는 0세부터 150세까지 입력 가능합니다.")

if retirement_age <= current_age:
    st.error("은퇴 나이는 현재 나이보다 커야 합니다.")
```

**사용자 경험**:

- 범위를 벗어나면 즉시 피드백 제공
- 입력 필드 아래에 범위 힌트 표시
  - 예: "나이 (0~150세)"

---

### 3. 필수 입력 누락 처리

**문제 상황**:

- 필수 입력 항목이 비어있을 때 계산 버튼 클릭
- 일부 필수 항목만 입력된 상태

**제안**:

#### 옵션 A: 버튼 비활성화 (추천)

- 필수 입력이 모두 채워지기 전까지 "계산하기" 버튼 비활성화
- 비활성화된 버튼에 툴팁 표시: "모든 필수 항목을 입력해주세요"
- 누락된 필수 항목 목록 표시

#### 옵션 B: 계산 시도 시 에러 표시

- 계산 버튼 클릭 시 누락된 필드 확인
- 상단에 에러 메시지 박스 표시
- 누락된 필드에 빨간 테두리 표시

**권장**: 옵션 A (버튼 비활성화) - 실수 방지

**구현 예시**:

```python
required_fields = {
    'current_age': current_age,
    'retirement_age': retirement_age,
    'salary': salary,
    'monthly_expense': monthly_expense,
    'total_assets': total_assets,
    'total_debt': total_debt
}

missing_fields = [k for k, v in required_fields.items() if v is None or v == '']

if missing_fields:
    st.warning(f"다음 필수 항목을 입력해주세요: {', '.join(missing_fields)}")
    calculate_button = st.button("계산하기", disabled=True)
else:
    calculate_button = st.button("계산하기")
```

---

### 4. 잘못된 형식 입력

**문제 상황**:

- 숫자 필드에 텍스트 입력
- 천 단위 구분 기호 처리 (예: "1,000만원" vs "1000만원")
- 소수점 입력 (예: "100.5만원")

**제안**:

#### 숫자 형식 처리

- **천 단위 구분 기호**: 자동 제거
  - "1,000만원" → 1000
  - "10,000,000" → 10000000
- **소수점**: 반올림 또는 경고
  - 소수점 입력 시 경고: "정수로 반올림됩니다"
  - 또는 소수점 허용 (소액 자산 고려)
- **텍스트 입력**: 즉시 에러 표시
  - "숫자만 입력 가능합니다"
  - 입력 필드 초기화 제안

#### 구현 방법

```python
def clean_number_input(value):
    """숫자 입력 정제"""
    if value is None or value == '':
        return None

    # 텍스트인 경우
    if isinstance(value, str):
        # 천 단위 구분 기호 제거
        value = value.replace(',', '').replace(' ', '')
        # "만원", "원" 등 단위 제거
        value = re.sub(r'[만원억조]', '', value)

        try:
            # 소수점 처리 (반올림)
            return int(round(float(value)))
        except ValueError:
            return None

    return int(value)
```

---

### 5. 논리적 검증

**문제 상황**:

- 월 지출이 연봉보다 큰 경우
- 부채가 자산보다 큰 경우 (음수 순자산)
- 은퇴 나이가 현재 나이보다 작은 경우

**제안**:

#### 경고 메시지 (계산은 진행)

- **월 지출 > 연봉**:
  - 경고: "월 지출이 월 소득보다 큽니다. 재정 상태를 확인해주세요."
  - 계산은 진행하되, 결과에 경고 표시
- **부채 > 자산**:
  - 경고: "부채가 자산보다 큽니다. 순자산이 음수입니다."
  - 계산은 진행하되, 위험도 높게 표시
- **은퇴 나이 < 현재 나이**:
  - 에러: "은퇴 나이는 현재 나이보다 커야 합니다."
  - 계산 중단

#### 구현 예시

```python
# 논리적 검증
warnings = []

if monthly_expense > salary / 12:
    warnings.append("⚠️ 월 지출이 월 소득보다 큽니다.")

if total_debt > total_assets:
    warnings.append("⚠️ 부채가 자산보다 큽니다. 순자산이 음수입니다.")

if retirement_age <= current_age:
    st.error("은퇴 나이는 현재 나이보다 커야 합니다.")
    return

# 경고 표시
if warnings:
    for warning in warnings:
        st.warning(warning)
```

---

## 구현 우선순위

### Phase 1 (필수)

1. ✅ 필수 입력 누락 처리 (버튼 비활성화)
2. ✅ 음수 입력 처리 (자동 보정)
3. ✅ 기본 범위 검증 (나이, 은퇴 나이)
4. ✅ 논리적 검증 (은퇴 나이 < 현재 나이)

### Phase 2 (권장)

5. ⚠️ 숫자 형식 처리 (천 단위 구분 기호)
6. ⚠️ 논리적 경고 (지출 > 소득, 부채 > 자산)
7. ⚠️ 상세 범위 검증 (모든 입력 항목)

---

## 사용자 경험 원칙

1. **명확한 피드백**: 에러 발생 시 즉시 알림
2. **자동 보정**: 가능한 경우 자동으로 수정 제안
3. **계산 중단 최소화**: 경고는 표시하되 계산은 진행 (가능한 경우)
4. **도움말 제공**: 각 입력 필드에 예시 및 범위 표시
